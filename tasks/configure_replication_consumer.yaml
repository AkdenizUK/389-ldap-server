---
  - name: Generate password hash for replication user
    shell: /usr/bin/pwdhash {{ replication_user_password }}
    register: pwd_hash_raw

  - name: Make a pwd hash variable
    set_fact: pwd_hash='{{ pwd_hash_raw.stdout }}'

  - name: Copy ldif templates
    template: src=templates/{{ item }}.j2 dest=/root/{{ item }}
    with_items:
     - consumer_replica.ldif
     - replication_user.ldif

#  - name: check dse content
#    shell: cat /etc/dirsrv/slapd-{{ serverid }}/dse.ldif
#    register: dse_contents
#
#  - name: Stopping Directory Server
#    service: name=dirsrv@{{ serverid }} state=stopped
#    when: "dse_contents.stdout.find('dn: cn=replication manager,cn=config') == -1"
#
#  - name: Add replication manager user
#    shell: cat /root/repluser.ldif >>/etc/dirsrv/slapd-{{ serverid }}/dse.ldif
#    when: "dse_contents.stdout.find('dn: cn=replication manager,cn=config') == -1"
#
#  - name: Starting Directory Server
#    service: name=dirsrv@{{ serverid }} state=started
#    when: "dse_contents.stdout.find('dn: cn=replication manager,cn=config') == -1"

  - name: Adding replication user
    shell: ldapmodify -D {{ ldap_rootdn }} -w {{ ldap_password }} -h localhost -v < /root/replication_user.ldif
    register: results
    failed_when:  not((results.rc == 0)or(results.stderr.find('Already exists') != -1))

  - debug: msg='Replication user already exists'
    when: results.stderr.find('exists') != -1

  - name: Copy installation templates (consumer replica)
    template: src=templates/{{ item }}.j2 dest=/root/{{ item }}
    with_items:
     - consumer_replica.ldif

  - name: Configuring consumer replica
    shell: ldapmodify -D {{ ldap_rootdn }} -w {{ ldap_password }} -h localhost -v < /root/consumer_replica.ldif
    register: results
    failed_when:  not((results.rc == 0)or(results.stderr.find('Already exists') != -1))

  - name: Restarting Directory Server
    service: name=dirsrv@{{ serverid }} state=restarted
    when: results.stderr.find('exists') == -1

